{% extends "base.html" %}{% block title %}Дефект #{{ obj.id }}{% endblock %}
{% block content %}
<h1>Дефект #{{ obj.id }} — {{ obj.title }}</h1>
<div class="grid">
  <div class="card">
    <h3>Карточка</h3>
    <p><b>Проект:</b> {{ obj.project }}{% if obj.stage %}, {{ obj.stage.name }}{% endif %}</p>
    <p><b>Статус:</b> {{ obj.get_status_display }} | <b>Приоритет:</b> {{ obj.get_priority_display }}</p>
    <p><b>Исполнитель:</b> {{ obj.assignee|default:"—" }} | <b>Срок:</b> {{ obj.due_date|default:"—" }}</p>
    <p><b>Описание:</b><br>{{ obj.description|linebreaks }}</p>
    <a class="btn" href="{% url 'defects:edit' obj.id %}">Править</a>
  </div>
  <div class="card">
    <h3>Смена статуса</h3>
    <form method="post" action="{% url 'defects:status' obj.id %}">{% csrf_token %}
      <select name="status">
        {% for code,name in obj._meta.get_field('status').choices %}
          {% if code in allowed_transitions %}<option value="{{ code }}" {% if code == obj.status %}selected{% endif %}>{{ name }}</option>{% endif %}
        {% endfor %}
      </select>
      <button class="btn" type="submit">Применить</button>
    </form>
  </div>
  <div class="card">
    <h3>Вложения</h3>
    <ul>{% for f in obj.attachments.all %}
      <li><a href="{{ f.file.url }}" target="_blank">{{ f.file.name|cut:"attachments/" }}</a> — {{ f.uploaded_by }}</li>
    {% empty %}<li>Нет файлов</li>{% endfor %}</ul>
    <form class="actions" method="post" enctype="multipart/form-data" action="{% url 'defects:attach' obj.id %}">{% csrf_token %}
      {{ attach_form.file }}<button class="btn">Загрузить</button>
    </form>
  </div>
  <div class="card" style="grid-column:1/-1;">
    <h3>Комментарии</h3>
    <ul>{% for c in obj.comments.all %}
      <li><b>{{ c.author }}</b> ({{ c.created_at|date:"d.m.Y H:i" }}): {{ c.text|linebreaks }}</li>
    {% empty %}<li>Комментариев нет</li>{% endfor %}</ul>
    <form method="post" action="{% url 'defects:comment' obj.id %}">{% csrf_token %}
      {{ comment_form.text }}<div class="actions"><button class="btn">Добавить</button></div>
    </form>
  </div>
  <div class="card" style="grid-column:1/-1;">
    <h3>История изменений</h3>
    <table><thead><tr><th>Время</th><th>Поле</th><th>Было</th><th>Стало</th><th>Автор</th></tr></thead>
      <tbody>{% for h in obj.history.all %}
        <tr><td>{{ h.changed_at|date:"d.m.Y H:i" }}</td><td>{{ h.field }}</td><td>{{ h.old_value }}</td><td>{{ h.new_value }}</td><td>{{ h.changed_by|default:"—" }}</td></tr>
      {% empty %}<tr><td colspan="5">Нет истории</td></tr>{% endfor %}</tbody></table>
  </div>
</div>
{% endblock %}
